# 着色基础

[TOC]

除了应该给3D物体渲染出正确的几何形状之外，还应当为它们渲染出合适的外观（可能是真实感的，也可能是风格话的）。

| ![1557631131131](.\Pictures\Fig5.1.png) |
|:-------------------------------------------------------------:|
| 图1：上：真实感渲染。下：风格化渲染。                                           |

## 着色模型

决定一个渲染物体的外观，首先需要选择一个合适的着色模型(`shading model`)。着色模型描述了一个物体的颜色和它的表面方向(法线)，视点方向，光照等因素的关系。

下面使用 *Gooch* 着色模型来说明上述因素对物体颜色的影响。*Gooch*是一个非真实感渲染的着色模型，它的基本做法是表面法线和光源的位置进行比较。如果法线指向光源，则使用暖色调着色，反之使用冷色调，中间的角度进行插值处理。

选择好一个着色模型后，通常需要设置这个模型的属性值，用来控制物体的外观变化。在 *Gooch* 模型中，只有一个属性，即表面颜色。

| ![1557642390031](.\Pictures\Fig5.2.png) |
|:-------------------------------------------------------------:|
| 图2：*Gooch* 模型在不同表面颜色下的着色效果。                                   |

如上所述，着色模型与表面方向和视点/光照方向有关。通常使用单位向量(`unit vector`)来表达这些方向。`Gooch` 着色模型的数学定义可以写成下面这样：
![1557642661181](.\Pictures\Fig5.3.png) 
![1557642681509](.\Pictures\Fig5.4.png) 

| ![1557643011086](.\Pictures\Fig5.5.png) |
|:-------------------------------------------------------------:|
| 图3：法线，光线，视线的单位向量表示                                            |

其中，$s$ 是高光部分的分量, $1-s$ 是漫反射部分的分量。漫反射部分由 $t$ 控制的暖冷色调分量进行合成。

公式的详细展开部分给出了，暖色调，冷色调和高光的颜色定义。值得注意的是:

- $t, \mathbf{r}, s $ 的计算用到了多次点乘，在图形学中，两个单位向量的点乘等于余弦值，用来度量两个向量的偏离程度。
- 当法线正向光源是，$t=1$,漫反射为完全的暖色调，当法线背向光源时，$t=0.5$, 冷暖色调各半，中间角度进行插值。
- $\mathbf{r}$ 计算的时光线的反射方向，反射方向与视点方向一致时，高光部分分量最大。
- $x^{\mp}$ 表示裁剪操作(`clamp`)，使得 $s$ 落在0-1 之间。

## 光源

真实世界的光源比上述例子仅提供一个光照方向的光源要复杂的多。每种不同种类的光源都会由各自的大小，形状，颜色，亮度。此外，非直接光有着更多的变种。这些因素在真实感/物理渲染中都需要考虑在内。

除此之外，光照计算下一步要解决着色模型对于光源是否可见的响应问题。物体表面受到直接光源影响时(`lit`)呈现一种外观，反之(`unlit`)呈现另外一种外观。形式化如下：

只考虑光源亮度$k_{light}$ : ![1557662295700](.\Pictures\Fig5.6.png)
扩展到RGB光源：![1557662323756](.\Pictures\Fig5.7.png)
扩展到多光源：![1557662392583](.\Pictures\Fig5.8.png) 

$f_{unlit}$ 表示没有收到直接光源影响的部分。它可能来源自环境光，反射的间接光等。当表面法线和光线夹角超过90度时，认为光源对物体表面没有影响。

光在表面上的影响可以看作一组光线，击中表面的光线密度与光强呈对应关系。

| ![1557663064603](.\Pictures\Fig5.9.png)          |
|:----------------------------------------------------------------------:|
| 图3：当$cos\theta>0$时，光线密度正比于法线与光线的夹角$cos\theta$；当$cos\theta<0$ 时，会被截断到0. |

有了光线与法线的关系，着色公式可以进一步展开。这一展开对基于物理的着色模型是必需的。

![1557663613647](.\Pictures\Fig5.10.png)

$Lambertian$ 着色模型简单认为 $f_{lit} = \mathbf{c}_{surface}$，也即只考虑漫反射光照。

![1557663939088](.\Pictures\Fig5.11.png)

由上述的公式可以看出，光源通过以下两个参数与着色模型关联起来：

- 着色点指向光源的向量 $l$

- 光源颜色 $\mathbf{c}_{light}$

不同的光源对着色的影响主要通过上述两个参数体现出来。下面将讨论不同光源类型对着色的影响，它们的共同点是光源只在**单一方向** $l$ 对物体表面进行光照（近似认为光源相对物体是一个非常小的点）。

### 方向光

通常而言，方向光的 $l$ 和 $c_{light}$ 都是常量（特殊情况，$c_{light}$ 在阴影下会衰减），没有固定的位置，如太阳光。出于性能或创造性的考虑，会将光的效果限制在场景的特定部分，此时 $c_{light}$ 是可变的部分。

### punctual light

点光源和聚光(*spotlight*)统称为 *punctual light*。这意味着它们拥有一个固定的位置，从一个固定的点往外发射光线。因此，对于一个着色点 $\mathbf{p}_0$，*punctual light* 的方向表示如下。

![1557665696632](.\Pictures\Fig5.12.png)

光源的距离 $r=||\mathbf{p}_{light}-\mathbf{p}_0||$ 除了用来归一化 $\mathbf{l}$ 向量，还用来计算光的颜色 $\mathbf{c}_{light}$ 的衰减函数。

#### 点光源

点光源(*point light*)往各个方向均匀发射光线。对点光源而言，$\mathbf{c}_{light}$仅随着距离$r$衰减。衰减的关系可以通过下图看出来。

| ![1558179985831](.\Pictures\Fig5.13.png) |
| :----------------------------------------------------------: |
|        图4：光线密度随着$r$增大而减少，正比于 $1/r^2$        |

通常，可以使用$\mathbf{c}_{light_0}$来表示在$r_0$处的光源颜色。$\mathbf{c}_{light}=\mathbf{c}_{light_0}(\frac{r_0}{r})^2$，表示他们的衰减关系。但在实际用于着色时，这样的表达会存在一些问题。

- $r$ 非常小时，会发生除0的奇异现象。通常可以加上一个很小的$\epsilon$来解决或者把分子截断在一个最小值以上。

  ![1558180472606](.\Pictures\Fig5.14.png)

  ![1558180552821](.\Pictures\Fig5.15.png)

- 倒数平方的衰减关系使得随着距离增大，$\mathbf{c}_{light}$无限接近于0。对这部分的计算会对视觉效果提升极小，浪费计算量。通过可以添加一个窗口函数(*windowing function*)来使得曲线的导数和值同时平滑下降到0。

  ![1558180910164](.\Pictures\Fig5.17.png)
| ![1558180848531](.\Pictures\Fig5.16.png) |
| :----------------------------------------------------------: |
|                        图5：窗口函数                         |

- 甚至，为了更高效的着色，不一定要拟合倒数平方的形式。而使用简单的距离函数$f_{dist}$来表达衰减关系。
  $$
  \mathbf{c}_{light}(r) = \mathbf{c}_{light0}f_{dist}(r)\\
  f_{dist}(r)=(1-(\frac{r}{r_{max}})^2)^{+2}
  $$

#### 聚光

#### 其他 *punctual light*

### 其他光源类型

面积光。

## 实现着色模型

### 计算频率

设计一个着色程序时，应该考虑到不同计算发生的频率。比如，在一个draw call中不会发生改变的量可以放到CPU端进行计算，在通过uniform传入shader程序中。根据计算频率可以将计算过程依次如下划分：

- 在整个着色过程中不会改变的量，如硬件配置等，应该放在程序初始化时完成
- 在每个draw call中会发生缓慢更新的量，但没必要每帧都去更新，可以多帧合并更新，如根据时间变化的太阳光。
- 每帧都必须更新的量，如视点，透视矩阵等。则需要把这些量传入到shader的uniform中。此外，由于他们的使用频率一致，将他们当成一组uniform量可以提高程序效率。
- 在每个draw call内会发生改变的量，则不同通过uniform传输，只能使用可变输入(*varying input*)。

此外，不同的可编程阶段的计算频率也不一致。

- Vertex shader - 逐顶点计算(细分前)
- Hull shader - 逐表面块(patch)计算
- Domain shader - 逐顶点计算(细分后)
- Geometry shader - 逐图元计算
- Pixel shader - 逐像素计算

尽管逐顶点计算的效率更高，在实践中，大部分时候都使用逐像素着色计算。逐顶点计算的线性插值会使得高频部分的光照计算产生偏差，因为高频部分的变化非线性。理论上，也可以在高光部分使用逐像素计算，其余部分使用逐顶点计算来提高效率和视觉效果，但实践意义不大。

| ![1558182849980](.\Pictures\Fig5.18.png) |
| :----------------------------------------------------------: |
|           图6：左：逐像素，中：逐顶点，右：仅线框            |

值得注意的是，尽管顶点着色器总是输出单位长度的法线，但是会被随后的插值改变它的长度。因此，需要在像素着色器中再次进行归一化的操作来保证输入的法线向量是单元向量，才不会发生计算错误。

| ![1558183210299](.\Pictures\Fig5.19.png) |
| :----------------------------------------------------------: |
|                  图7：错误的法线插值结果。                   |

和法线不同，指向特定位置的向量，比如视点向量和光线向量，通常不进行插值，而是通过插值后的表面位置进一步得到。即使有些情况下必须对他们进行插值，也不要先进行归一化处理，这会导致错误的计算结果。

| ![1558183640945](.\Pictures\Fig5.20.png) |
| :----------------------------------------------------------: |
|         图8：光线向量插值。左：归一化，右：未归一化          |

之前提到，顶点着色器负责把表面几何(顶点等)转换到合适的统一坐标系统下进行计算。但怎么衡量一个坐标系统是否合适？该选择世界坐标，还是相机坐标？需要根据渲染的场景来定。如果场景中包含大量光源，则可以选择世界坐标空间来避免光源位置的转换计算。否则，更多情况下都会选择相机坐标空间下进行计算，一方面可以更好的进行逐像素处理，另一方面对精度也有所提升。

### 示例实现

### 材质系统

